<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>塔羅占卜</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --gold: #f1c40f;
            --dark-gold: #d4ac0d;
            --text-gray: #eee;
            --font-title: 'Cinzel', 'Noto Serif TC', serif;
            --font-body: 'Noto Serif TC', serif;
            --nav-size: 50px;
            --btn-size: 65px;
        }

        ::selection { background: var(--gold); color: #000; }
        ::-moz-selection { background: var(--gold); color: #000; }

        body {
            font-family: var(--font-body); background-color: #1a0a1a;
            background-image: url("bg_cloth.png"); background-size: cover;
            background-attachment: fixed; color: var(--gold);
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; overflow-x: hidden;
        }

        @media (max-width: 768px) {
            body { background-attachment: scroll; background-size: auto; background-repeat: repeat; }
        }

        .header-container {
            display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 40px;
            background: rgba(0, 0, 0, 0.8); padding: 10px 30px; border-radius: 50px;
            border: 2px solid var(--dark-gold); box-shadow: 0 0 30px rgba(0,0,0,0.8); z-index: 1000;
        }
        .header-container h1 {
            font-family: var(--font-title); margin: 0; font-size: 1.8em; color: var(--gold);
            text-shadow: 2px 2px 10px rgba(0,0,0,0.9); letter-spacing: 2px; cursor: help;
            position: relative; line-height: 1.2; white-space: nowrap;
        }
        .header-container select {
            background-color: #000; color: var(--gold); border: none; font-family: var(--font-title);
            font-size: 1.8em; outline: none; cursor: pointer; font-weight: bold; line-height: 1.2; padding: 0 10px;
            appearance: none; -webkit-appearance: none;
        }
        .header-container h1::after {
            content: "偉特取「少數方」為【重點牌】,\A依照:1正逆位 2大小牌 3數字/人物\A 托特不判斷正逆位、重點牌。";
            position: absolute; top: 120%; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); color: var(--gold); border: 1px solid var(--dark-gold);
            padding: 10px 20px; border-radius: 8px; font-family: var(--font-body); font-size: 0.45em;
            line-height: 1.5; width: max-content; white-space: pre;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 3000;
        }
        .header-container h1:hover::after { opacity: 1; }

        .right-fixed-panel {
            position: fixed; right: 0; top: 20%; display: flex; flex-direction: column;
            align-items: flex-end; gap: 35px; z-index: 2000;
        }

        #drawBtn {
            position: relative; width: var(--btn-size); height: var(--btn-size); border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: #1a0a1a; border: 2px solid var(--dark-gold); font-weight: bold;
            cursor: pointer; transition: 0.3s; font-family: var(--font-title);
            display: flex; align-items: center; justify-content: center;
            font-size: 1em; margin-right: 25px; opacity: 0.4;
        }
        #drawBtn:hover { opacity: 1; transform: scale(1.05); }
        #drawBtn.busy { font-size: 0.8em; opacity: 1; }
        #drawBtn.busy::after {
            content: ""; position: absolute; width: 85%; height: 85%;
            border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #fff;
            border-radius: 50%; animation: spinnerRotate 0.8s linear infinite;
            top: 7.5%; left: 7.5%;
        }
        #drawBtn.shuffling { background: #444; color: white; border-color: #777; }
        @keyframes spinnerRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        #navDots { display: flex; flex-direction: column; gap: 20px; margin-right: 25px; align-items: center; }
        .nav-dot {
            width: var(--nav-size); height: var(--nav-size); background: rgba(0,0,0,0.7);
            border: 2px solid var(--dark-gold); border-radius: 50%; color: var(--gold);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            text-decoration: none; opacity: 0; transition: all 0.3s ease; font-family: var(--font-title);
        }
        /* Sprint 3: 導航點彈性動畫 */
        .nav-dot.visible { 
            opacity: 0.4; 
            animation: dotBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .nav-dot.visible:hover {
            opacity: 1 !important;
            transform: scale(1.1);
            box-shadow: 0 0 15px var(--gold);
        }
        /* Sprint 3: 消失動畫 (往上收) */
        .nav-dot.out, #snapshotBtn.out {
            opacity: 0 !important;
            transform: translateY(-30px) scale(0.5) !important;
            transition: all 0.5s cubic-bezier(0.4, 0, 1, 1) !important;
        }
        @keyframes dotBounce {
            from { opacity: 0; transform: scale(0.3) translateX(20px); }
            to { opacity: 0.4; transform: scale(1) translateX(0); }
        }

        /* Sprint 3: 收牌狀態 */
        .card-container.collecting {
            opacity: 0;
            transform: translateY(-200px) scale(0.5) rotate(10deg);
            filter: blur(5px);
            transition: all 0.6s cubic-bezier(0.4, 0, 1, 1);
        }
        .nav-dot.visible:hover { opacity: 1; transform: scale(1.1); }
        .nav-dot.focus-dot { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); opacity: 0.6; }
        .nav-dot.focus-dot:hover { opacity: 1; }

        #snapshotBtn {
            width: calc(var(--btn-size) * 2.4); height: calc(var(--btn-size) * 0.9);
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: #1a0a1a; border: 2px solid var(--dark-gold); 
            border-radius: 35px 0 0 35px;
            font-weight: bold; cursor: pointer; opacity: 0; 
            transform: translateX(40px);
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            pointer-events: none; font-family: var(--font-body);
            font-size: 1.1em; padding-left: 15px; text-align: left;
            box-shadow: -5px 5px 20px rgba(0,0,0,0.6);
        }
        #snapshotBtn.visible { opacity: 0.5; transform: translateX(30px); pointer-events: auto; }
        #snapshotBtn.visible:hover { opacity: 1; transform: translateX(10px); }
        #snapshotBtn.processing { filter: grayscale(1); opacity: 0.8; cursor: wait; }

        .board { display: flex; flex-direction: column; gap: 40px; width: 100%; max-width: 900px; padding-bottom: 100px; }
        .card-container {
            position: relative; background: rgba(0,0,0,0.3); padding: 25px 30px; border-radius: 5px;
            border: 1px solid rgba(212,172,13,0.4); margin: 0 auto; width: 90%;
            min-height: 400px; max-height: 400px; overflow: hidden;
            /* Sprint 2: 初始狀態設為上方飛入位置 */
            opacity: 0; transform: translateY(-100px) scale(0.8); 
            transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1), 
                        transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), 
                        max-height 1.2s cubic-bezier(0.16, 1, 0.3, 1),
                        box-shadow 0.6s ease;
        }
        .card-container.active-board { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        /* 翻牌時增加陰影深度，模擬離地感 */
        .card-container.flipped {
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
        }
        .card-container.expanded { max-height: 1000px; opacity: 1; }
        .card-container.focus-card { border: 2px solid var(--gold); box-shadow: 0 0 30px rgba(241, 196, 15, 0.2); }

        .ornament-top, .ornament-bottom { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .ornament-top::before, .ornament-top::after, .ornament-bottom::before, .ornament-bottom::after {
            content: ""; position: absolute; width: 60px; height: 60px; background-image: url("corner_pattern.svg"); background-size: contain; background-repeat: no-repeat;
        }
        .ornament-top::before { top: 0; left: 0; } .ornament-top::after { top: 0; right: 0; transform: rotate(90deg); }
        .ornament-bottom::before { bottom: 0; left: 0; transform: rotate(-90deg); } .ornament-bottom::after { bottom: 0; right: 0; transform: rotate(180deg); }
        .focus-card .ornament-top::before, .focus-card .ornament-top::after, .focus-card .ornament-bottom::before, .focus-card .ornament-bottom::after {
            background-image: url("corner_pattern_focus.svg"); width: 80px; height: 80px; filter: drop-shadow(0 0 5px var(--gold));
        }

        .card-visual { display: flex; align-items: center; gap: 35px; width: 100%; position: relative; z-index: 5; }
        .flip-container { width: 180px; height: 310px; perspective: 1500px; flex-shrink: 0; }
        .flipper { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .flipped .flipper { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 8px; border: 2px solid var(--dark-gold); overflow: hidden; }
        .front { transform: rotateY(180deg); background: #000; } .back { background: #2c3e50; }
        .back img, .tarot-card { width: 100%; height: 100%; object-fit: cover; }
        .reversed { transform: rotate(180deg); }

        .card-name {
            display: flex; flex-direction: column; align-items: center; flex-grow: 1;
            font-family: var(--font-title); font-size: 1.8em; color: var(--gold); opacity: 0; transition: 0.5s 0.6s;
        }
        .flipped .card-name { opacity: 1; }
        .key-label { font-size: 0.4em; border: 1px solid var(--gold); padding: 2px 8px; margin-top: 10px; border-radius: 3px; background: rgba(241,196,15,0.1); }

        .meaning-content { opacity: 0; transition: 0.8s 1.2s; padding-top: 20px; position: relative; z-index: 5; }
        .flipped .meaning-content { opacity: 1; }
        .meaning-desc { font-size: 1.1em; line-height: 1.8; margin-bottom: 20px; background: rgba(0,0,0,0.5); padding: 15px; border-left: 5px solid var(--dark-gold); border-radius: 0 8px 8px 0; }
        .aspect-list { list-style: none; padding: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .aspect-list li { background: rgba(255, 255, 255, 0.1); padding: 12px 18px; border-radius: 10px; font-size: 0.95em; color: #eee; }
        .aspect-list li b { color: var(--gold); margin-right: 8px; }

        #initialDeckStack { position: relative; width: 180px; height: 310px; }
        .deck-card-offset { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; border: 2px solid var(--dark-gold); background: #2c3e50; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }

        #manualModal .manual-row {
            display: flex; justify-content: space-between; align-items: center; gap: 15px;
            margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 15px 25px; border-radius: 10px; width: 100%; box-sizing: border-box;
        }
        #manualModal select {
            background-color: #000 !important; color: var(--gold) !important;
            border: 1px solid var(--dark-gold) !important; padding: 10px 15px; border-radius: 5px;
            font-family: var(--font-body); font-size: 1.1em; cursor: pointer; outline: none; flex: 1;
            appearance: none; -webkit-appearance: none; text-align: center;
        }
        #manualModal select:disabled { background: #222 !important; color: #666 !important; border-color: #444 !important; }
    </style>
</head>
<body>
    <div class="right-fixed-panel">
        <button id="drawBtn" onclick="handleBtnClick()">抽牌</button>
        <div id="navDots"></div>
        <button id="snapshotBtn" onclick="takeSnapshot()">儲存截圖</button>
    </div>

    <div class="header-container">
        <span class="decoration-star">✦</span>
        <select id="tarotType" onchange="handleTypeChange()">
            <option value="waite">偉特</option>
            <option value="thoth">托特</option>
        </select>
        <h1 onclick="handleTitleClick()">塔羅占卜</h1>
        <select id="numCards">
            <option value="5" selected>五牌</option>
            <option value="3">三牌</option>
            <option value="1">一牌</option>
        </select>
        <span class="decoration-star">✦</span>
    </div>

    <div class="board" id="cardBoard">
        <div class="card-container active-board focus-card" id="mainContainer"></div>
    </div>

    <div id="manualModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; padding:40px 20px; box-sizing:border-box; overflow-y:auto;">
        <div style="width:70%; max-width:850px; margin:0 auto; color:var(--gold); display:flex; flex-direction:column; align-items:center;">
            <h2 style="text-align:center; font-family:var(--font-title); font-size:2em; margin-bottom:30px;">手動擺牌</h2>
            <div id="manualSelectors" style="width:100%;"></div>
            <div style="display:flex; gap:20px; justify-content:center; margin-top:30px; padding-bottom:50px;">
                <button onclick="closeManualModal()" style="padding:12px 30px; cursor:pointer; background:#444; color:#fff; border:none; border-radius:5px;">取消</button>
                <button onclick="confirmManualDraw()" style="padding:12px 50px; background:var(--gold); font-weight:bold; cursor:pointer; color:#000; border:none; border-radius:5px;">開始擺牌</button>
            </div>
        </div>
    </div>

    <template id="cardTemplate">
        <div class="ornament-top"></div> <div class="ornament-bottom"></div>
        <div class="card-visual">
            <div class="flip-container"><div class="flipper"><div class="back"><img src="tarot_cards/0_back.jpg"></div><div class="front"></div></div></div>
            <div class="card-name"><span class="name-text"></span><span class="key-label" style="display:none;">重點牌</span></div>
        </div>
        <div class="meaning-content"><div class="meaning-desc"></div><ul class="aspect-list"><li><b>愛情：</b><span class="love-text"></span></li><li><b>財富：</b><span class="wealth-text"></span></li><li><b>工作：</b><span class="work-text"></span></li><li><b>外表：</b><span class="appearance-text"></span></li><li><b>健康：</b><span class="health-text"></span></li></ul></div>
    </template>

    <script>
        const tarotConfigs = {
            waite: { path: 'data/waite/', files: ['data_major.js', 'data_wands.js', 'data_cups.js', 'data_swords.js', 'data_pentacles.js'] },
            thoth: { path: 'data/thoth/', files: ['data_major.js', 'data_wands.js', 'data_cups.js', 'data_swords.js', 'data_disks.js'] }
        };

        async function loadTarotSet(type) {
            window.tarotData = []; const config = tarotConfigs[type];
            const loadPromises = config.files.map(file => { return new Promise((resolve) => { const script = document.createElement('script'); script.src = config.path + file; script.onload = () => resolve(); document.body.appendChild(script); }); });
            await Promise.all(loadPromises);
            let flattenedData = []; window.tarotData.forEach(item => { flattenedData = flattenedData.concat(Array.isArray(item) ? item : [item]); });
            window.tarotData = flattenedData.sort((a, b) => a.id - b.id);
        }

        function initStartStack() {
            const main = document.getElementById('mainContainer');
            main.innerHTML = `<div class="ornament-top"></div><div class="ornament-bottom"></div><div class="card-visual" id="stackVisual"><div id="initialDeckStack"><div class="deck-card-offset" style="transform: translate(8px, 8px) rotate(3deg);"></div><div class="deck-card-offset" style="transform: translate(-5px, 5px) rotate(-2deg);"></div><div class="deck-card-offset" id="topCard"><img src="tarot_cards/0_back.jpg" style="width:100%; height:100%; object-fit:cover;"></div></div></div>`;
            main.className = 'card-container active-board focus-card';
        }

        window.onload = () => { loadTarotSet(document.getElementById('tarotType').value); initStartStack(); };

        let isDrawing = false, hasDrawn = false, lastSelectedCards = [];

        function handleBtnClick() { if (isDrawing) return; if (!hasDrawn) initiateDraw(); else initiateShuffle(); }

        const analyzeFocusCards = (cards, numCards) => {
            const currentType = document.getElementById('tarotType').value; if (currentType === 'thoth') return cards.map(() => Math.random() < 0.5);
            const reversed = cards.filter(c => c.isReversed); const upright = cards.filter(c => !c.isReversed);
            if (reversed.length !== 0 && upright.length !== 0 && reversed.length !== upright.length) { const focusReversed = reversed.length < upright.length; return cards.map(c => c.isReversed === focusReversed); }
            const isMajor = (id) => id >= 56 && id <= 77; const majors = cards.filter(c => isMajor(c.id)); const minors = cards.filter(c => !isMajor(c.id));
            if (majors.length > 0 && minors.length > 0 && majors.length !== minors.length) { const focusMajors = majors.length < minors.length; return cards.map(c => isMajor(c.id) === focusMajors); }
            return Array(numCards).fill(false);
        };

        async function initiateDraw(manualCards = null) {
            if (isDrawing) return; isDrawing = true;
            const drawBtn = document.getElementById('drawBtn'); drawBtn.innerText = "抽牌中"; drawBtn.classList.add('busy');
            const numCardsToDraw = parseInt(document.getElementById('numCards').value); const currentType = document.getElementById('tarotType').value;

            if (manualCards) lastSelectedCards = manualCards;
            else { let availableIds = tarotData.map(c => c.id); lastSelectedCards = []; for(let i=0; i<numCardsToDraw; i++) { const randIndex = Math.floor(Math.random() * availableIds.length); const cardIdx = availableIds.splice(randIndex, 1)[0]; const isReversed = (currentType === 'thoth') ? false : (Math.random() < 0.5); const cardData = tarotData.find(d => d.id === cardIdx); lastSelectedCards.push({ ...cardData, isReversed }); } }

            const focusMap = analyzeFocusCards(lastSelectedCards, numCardsToDraw);
            const board = document.getElementById('cardBoard'); const mainContainer = document.getElementById('mainContainer'); const navDotsContainer = document.getElementById('navDots'); navDotsContainer.innerHTML = '';

            const containers = []; for(let i=0; i<numCardsToDraw; i++) { const container = (i === 0) ? mainContainer : document.createElement('div'); if (i > 0) { container.className = 'card-container'; board.appendChild(container); } lastSelectedCards[i].isFocus = focusMap[i]; container.classList.remove('focus-card', 'expanded', 'flipped'); if (focusMap[i]) container.classList.add('focus-card'); containers.push(container); const dot = document.createElement('a'); dot.className = 'nav-dot' + (focusMap[i] ? ' focus-dot' : ''); dot.id = `nav-dot-${i}`; dot.innerText = i + 1; dot.onclick = (e) => { e.preventDefault(); container.scrollIntoView({behavior:'smooth', block:'center'}); }; navDotsContainer.appendChild(dot); }

            const template = document.getElementById('cardTemplate'); 
            
            // Sprint 3 優化：預載所有圖片，確保節奏同步且快速
            const loadImages = lastSelectedCards.map(card => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = `tarot_cards/A${card.id}.jpg`;
                    img.onload = () => resolve({ img, id: card.id });
                });
            });

            const loadedAssets = await Promise.all(loadImages);

            for(let i=0; i<numCardsToDraw; i++) { 
                const container = containers[i]; 
                const card = lastSelectedCards[i]; 
                container.innerHTML = ''; 
                const cardFragment = document.importNode(template.content, true); 
                
                const asset = loadedAssets.find(a => a.id === card.id);
                const frontImg = asset.img;
                frontImg.className = `tarot-card ${card.isReversed ? 'reversed' : ''}`;
                
                cardFragment.querySelector('.front').appendChild(frontImg);
                cardFragment.querySelector('.name-text').innerText = `${card.name}${currentType==='thoth'?'':(card.isReversed?' 逆位':' 正位')}`; 
                
                if (currentType !== 'thoth' && focusMap[i]) cardFragment.querySelector('.key-label').style.display = 'inline-block'; 
                
                const meaning = card.isReversed ? card.rev : card.up; 
                cardFragment.querySelector('.meaning-desc').innerText = meaning.desc; 
                
                if (currentType === 'thoth') cardFragment.querySelector('.aspect-list').style.display = 'none'; 
                else { 
                    cardFragment.querySelector('.love-text').innerText = meaning.love; 
                    cardFragment.querySelector('.wealth-text').innerText = meaning.wealth; 
                    cardFragment.querySelector('.work-text').innerText = meaning.work; 
                    cardFragment.querySelector('.appearance-text').innerText = meaning.appearance; 
                    cardFragment.querySelector('.health-text').innerText = meaning.health; 
                } 
                
                container.appendChild(cardFragment); 

                // 使用固定時序觸發，確保 1 -> 5 順序正確且節奏緊湊
                setTimeout(() => { 
                    const dot = document.getElementById(`nav-dot-${i}`);
                    if (dot) dot.classList.add('visible');
                    container.classList.add('active-board'); 
                    
                    setTimeout(() => {
                        container.classList.add('flipped'); 
                        setTimeout(() => container.classList.add('expanded'), 400); 
                    }, 300);
                    
                }, i * 250); // 縮短間隔至 250ms，提升流暢感
            }

            setTimeout(() => { 
                isDrawing = false; 
                hasDrawn = true; 
                drawBtn.innerText = "洗牌"; 
                drawBtn.classList.remove('busy'); 
                drawBtn.classList.add('shuffling'); 
                
                setTimeout(() => {
                    document.getElementById('snapshotBtn').classList.add('visible');
                    document.getElementById('snapshotBtn').classList.remove('out');
                }, 300);
            }, (numCardsToDraw - 1) * 250 + 800);
        }

        async function initiateShuffle() {
            if (isDrawing) return; isDrawing = true;
            const btn = document.getElementById('drawBtn'); btn.innerText = "洗牌中"; btn.classList.add('busy');
            const containers = document.querySelectorAll('.card-container'); 
            const navDots = Array.from(document.querySelectorAll('.nav-dot'));
            const snapBtn = document.getElementById('snapshotBtn');
            
            // 1. 截圖按鈕先收
            snapBtn.classList.add('out');
            snapBtn.classList.remove('visible');
            
            // 2. 導覽點倒序收回 (5 -> 1)
            navDots.reverse().forEach((d, idx) => {
                setTimeout(() => {
                    d.classList.add('out');
                    d.classList.remove('visible');
                }, idx * 100);
            });

            // 等待按鈕與導覽點收完
            await new Promise(r => setTimeout(r, 600));

            // 3. 執行牌卡收回動畫
            containers.forEach((c, idx) => {
                c.classList.remove('expanded', 'flipped');
                setTimeout(() => {
                    c.classList.add('collecting');
                }, idx * 50);
            });

            await new Promise(r => setTimeout(r, 800)); 

            document.getElementById('navDots').innerHTML = '';
            containers.forEach((c, idx) => { if (idx === 0) initStartStack(); else c.remove(); });
            hasDrawn = false; isDrawing = false; btn.innerText = "抽牌"; btn.classList.remove('shuffling', 'busy'); 
            snapBtn.classList.remove('out'); 
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function takeSnapshot() {
            const btn = document.getElementById('snapshotBtn'); if (!btn || btn.classList.contains('processing')) return;
            btn.classList.add('processing'); btn.innerText = "生成中...";
            const watchdog = setTimeout(() => { if (btn.classList.contains('processing')) { btn.classList.remove('processing'); btn.innerText = "儲存截圖"; } }, 5000);
            const snapshotData = { type: document.getElementById('tarotType').value, timestamp: new Date(), cards: JSON.parse(JSON.stringify(lastSelectedCards)).map(c => ({ name: c.name + (document.getElementById('tarotType').value==='waite'?(c.isReversed?' 逆位':' 正位'):''), isFocus: c.isFocus, meaning: (c.isReversed ? c.rev.desc : c.up.desc) })) };
            renderAndCapture(snapshotData, watchdog);
        }

        async function renderAndCapture(data, watchdog) {
            const btn = document.getElementById('snapshotBtn'); const renderTarget = document.createElement('div');
            renderTarget.style = `position:absolute; left:-9999px; top:0; width:800px; min-height:1400px; background:linear-gradient(135deg, #1a0a1a 0%, #2D1259 50%, #050226 100%); color:#f1c40f; font-family:'Noto Serif TC', serif; display:flex; flex-direction:column; align-items:center; padding:60px 0; box-sizing:border-box;`;
            renderTarget.innerHTML = `<div style="font-size:60px; letter-spacing:15px; font-weight:bold; margin-bottom:10px;">塔羅占卜</div><div style="font-size:20px; opacity:0.7; letter-spacing:5px; margin-bottom:30px;">✦ ${data.type==='waite'?'偉特塔羅':'托特塔羅'} ✦</div>`;
            const cardArea = document.createElement('div'); cardArea.style = "width:100%; flex-grow:1; position:relative; margin:20px 0;"; renderTarget.appendChild(cardArea);
            const num = data.cards.length; const CX = 400; 
            const cW = (num === 1 ? 540 : (num === 3 ? 360 : 300)); const cH = (num === 1 ? 810 : (num === 3 ? 540 : 450));
            
            // 完美同步 index_working.html 的座標計算
            let pos = [];
            if (num === 1) pos = [{x:CX, y:120}];
            else if (num === 3) {
                const vSpace = -90; const topY = (1120 - cH * 2 - vSpace - 150) / 2;
                pos = [{x:CX - cW / 2 - 40, y:topY}, {x:CX + cW / 2 + 40, y:topY}, {x:CX, y:topY + cH + vSpace}];
            } else {
                const layouts = [[{x:CX-260, y:40}, {x:CX, y:40}, {x:CX+260, y:40}, {x:CX-150, y:520}, {x:CX+150, y:520}], [{x:CX-150, y:40}, {x:CX+150, y:40}, {x:CX-260, y:520}, {x:CX, y:520}, {x:CX+260, y:520}]];
                pos = layouts[Math.floor(Math.random() * layouts.length)];
            }

            data.cards.forEach((card, idx) => {
                const cardBox = document.createElement('div'); const isF = card.isFocus;
                const rot = (num === 1 ? 0 : (isF ? (Math.random() * 10 - 5) : (Math.random() * 30 - 15)));
                cardBox.style = `width:${cW}px; height:${cH}px; position:absolute; padding:35px 25px; box-sizing:border-box; border-radius:15px; display:flex; flex-direction:column; align-items:center; top:${pos[idx].y}px; left:${pos[idx].x}px; transform:translateX(-50%) rotate(${rot}deg); z-index:${isF?1000:100}; background:${isF?'rgba(77,53,17,0.95)':'rgba(44,47,51,0.9)'}; border:${isF?'3px solid #f1c40f':'1.5px solid #bdc3c7'}; box-shadow:0 15px 40px rgba(0,0,0,0.6);`;
                
                let nS, mS;
                if (data.type === 'thoth') {
                    if (num === 1) { nS = 56; mS = 42; } else if (num === 3) { nS = 44; mS = 34; } else { nS = 40; mS = 30; }
                } else {
                    if (num === 1) { nS = 56; mS = 28; } else if (num === 3) { nS = 44; mS = 22; } else { nS = 40; mS = 20; }
                }

                cardBox.innerHTML = `<div style="width:100%; border-bottom:1px solid ${isF?'#f1c40f':'#7f8c8d'}; padding-bottom:15px; margin-bottom:20px; text-align:center;"><div style="font-size:${nS}px; font-weight:bold; color:${isF?'#f1c40f':'#ffffff'};">${card.name}</div></div>${isF?'<div style="background:#f1c40f; color:#1a0a1a; padding:3px 18px; border-radius:4px; font-size:16px; font-weight:bold; margin-bottom:15px;">重點牌</div>':''}<div style="font-size:${mS}px; line-height:1.7; color:#eee; text-align:${data.type==='thoth'?'center':'justify'};">${data.type==='thoth'?card.meaning.replace(/, /g,',<br>'):card.meaning}</div>`;
                cardArea.appendChild(cardBox);
            });
            const footer = document.createElement('div'); footer.style = "width:100%; text-align:center; padding:40px 0; font-size:24px; color:rgba(241,196,15,0.6); border-top:1px solid rgba(241,196,15,0.2);";
            footer.innerText = `占卜時間：${data.timestamp.toLocaleString()}`; renderTarget.appendChild(footer);
            document.body.appendChild(renderTarget);
            try { 
                await new Promise(r => setTimeout(r, 600)); 
                const canvas = await html2canvas(renderTarget, { backgroundColor: "#1a0a1a", scale: 2, width: 800 }); 
                
                // 格式化檔名: Tarot_Waite_YYYYMMDD_HHMM.jpg
                const now = data.timestamp;
                const dateStr = now.getFullYear() + 
                                String(now.getMonth() + 1).padStart(2, '0') + 
                                String(now.getDate()).padStart(2, '0') + "_" +
                                String(now.getHours()).padStart(2, '0') + 
                                String(now.getMinutes()).padStart(2, '0');
                const typeStr = data.type.charAt(0).toUpperCase() + data.type.slice(1);
                const filename = `Tarot_${typeStr}_${dateStr}.jpg`;

                showPreview(canvas.toDataURL('image/jpeg', 0.9), filename); 
            } catch (err) { alert("截圖失敗"); }
            finally { if (document.body.contains(renderTarget)) document.body.removeChild(renderTarget); clearTimeout(watchdog); btn.classList.remove('processing'); btn.innerText = "儲存截圖"; }
        }
        function showPreview(src, filename) {
            const div = document.createElement('div'); div.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box; backdrop-filter:blur(5px); color:var(--gold);";
            div.innerHTML = `<div style="margin-bottom:20px; font-size:1.2em;">✦ 手機長按圖片儲存，PC點擊下方按鈕 ✦</div><img src="${src}" style="max-width:95%; max-height:75vh; border:2px solid var(--gold); border-radius:10px;"><div style="display:flex; gap:20px; margin-top:30px;"><a href="${src}" download="${filename}" style="background:var(--gold); color:#000; padding:12px 40px; text-decoration:none; border-radius:30px; font-weight:bold;">儲存圖片</a><button onclick="this.parentElement.parentElement.remove()" style="background:transparent; color:var(--gold); border:1px solid var(--gold); padding:12px 40px; border-radius:30px; cursor:pointer;">關閉預覽</button></div>`;
            document.body.appendChild(div);
        }
        async function handleTypeChange() { if (isDrawing) return alert("抽牌中，請稍候。"); if (hasDrawn && confirm("切換牌組將清空結果，確定嗎？")) { await initiateShuffle(); loadTarotSet(document.getElementById('tarotType').value); } else if (!hasDrawn) loadTarotSet(document.getElementById('tarotType').value); }
        let titleClicks = 0, titleTimer = null;
        function handleTitleClick() { titleClicks++; clearTimeout(titleTimer); titleTimer = setTimeout(() => titleClicks = 0, 1000); if (titleClicks === 3 && !isDrawing && !hasDrawn) openManualModal(); }
        function openManualModal() {
            const container = document.getElementById('manualSelectors'); container.innerHTML = ''; const num = parseInt(document.getElementById('numCards').value); const isThoth = document.getElementById('tarotType').value === 'thoth';
            for (let i = 0; i < num; i++) { const row = document.createElement('div'); row.className = 'manual-row'; row.innerHTML = `${i+1} <select id="m-cat-${i}" onchange="updateCardList(${i})"><option value="大塔羅">大塔羅</option><option value="權杖">權杖</option><option value="聖杯">聖杯</option><option value="寶劍">寶劍</option><option value="錢幣">錢幣</option></select> <select id="m-card-${i}"></select> <select id="m-rev-${i}" ${isThoth?'disabled':''} style="${isThoth?'background:#333;color:#666;':''}"><option value="false">正</option><option value="true">逆</option></select>`; container.appendChild(row); updateCardList(i); }
            document.getElementById('manualModal').style.display = 'block';
        }
        function updateCardList(idx) {
            const cat = document.getElementById(`m-cat-${idx}`).value; const select = document.getElementById(`m-card-${idx}`); select.innerHTML = '';
            tarotData.filter(c => { if (cat === '大塔羅') return c.id >= 56 && c.id <= 77; if (cat === '權杖') return c.id >= 0 && c.id <= 13; if (cat === '寶劍') return c.id >= 14 && c.id <= 27; if (cat === '聖杯') return c.id >= 28 && c.id <= 41; if (cat === '錢幣') return c.id >= 42 && c.id <= 55; }).forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.innerText = c.name; select.appendChild(opt); });
        }
        function closeManualModal() { document.getElementById('manualModal').style.display = 'none'; }
        async function confirmManualDraw() { const cards = []; for (let i = 0; i < parseInt(document.getElementById('numCards').value); i++) { const id = parseInt(document.getElementById(`m-card-${i}`).value); cards.push({ ...tarotData.find(d => d.id === id), isReversed: document.getElementById(`m-rev-${i}`).value === 'true' }); } closeManualModal(); initiateDraw(cards); }
    </script>
</body>
</html>